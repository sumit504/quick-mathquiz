<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Math</title>
    
    <meta name="fc:miniapp" content='{
        "version":"1",
        "imageUrl":"https://quick-mathquiz.vercel.app/image.png",
        "button":{
            "title":"Play Quick Math & Earn!",
            "action":{
                "type":"launch_frame",
                "name":"Quick Math",
                "url":"https://quick-mathquiz-tau.vercel.app",
                "splashImageUrl":"https://quick-mathquiz.vercel.app/splash.png",
                "splashBackgroundColor":"#cce5ff"
            }
        }
    }' />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #87CEEB; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 0px; }
        .game-container { background: rgb(201, 221, 253); border-radius: 0px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2); max-width: 0px; width: 100%; overflow: hidden; height: 100vh; overflow-y: auto; }
        .game-header { background: #264bb1; color: white; padding: 25px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .game-title-section { display: flex; align-items: center; gap: 25px; }
        .header-avatar { width: 100px; height: 100px; border-radius: 12px; background: #444; display: none; align-items: center; justify-content: center; font-size: 25px; font-weight: bold; overflow: hidden; border: 2px solid #ffffff; }
        .header-avatar.show { display: flex; }
        .header-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .game-title { font-size: 24px; font-weight: bold; white-space: nowrap; }
        .leaderboard-btn { background: #EAB308; color: black; border: none; padding: 10px 10px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .leaderboard-btn:hover { background: #CA8A04; transform: scale(1.05); }
        .stats { display: flex; gap: 20px; margin-bottom: 15px; font-size: 14px; }
        .progress-boxes { display: flex; gap: 8px; }
        .progress-box { flex: 1; height: 48px; border-radius: 10px; border: 2px solid #a2a2a2; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.3s; }
        .progress-box.correct { background: #22C55E; border-color: #cfffe1; color: white; }
        .progress-box.active { background: #EAB308; border-color: #CA8A04; color: white; }
        .progress-box.inactive { background: #374151; border-color: #e2e2e2; color: #e6eeff; }
        .game-content { padding: 30px; }
        .start-screen, .game-screen, .result-screen { text-align: center; }
        .game-icon { font-size: 80px; margin-bottom: 20px; }
        .wallet-container { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(74, 144, 226, 0.3); border-radius: 15px; padding: 15px; margin: 20px 0; backdrop-filter: blur(10px); text-align: center; }
        .wallet-status { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; font-size: 14px; color: #1F2937; }
        .wallet-indicator { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; animation: pulse 2s infinite; }
        .wallet-indicator.connected { background: #10b981; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #walletAddress { font-family: monospace; margin: 8px 0; font-size: 13px; color: #6B7280; }
        .game-screen .question-number { color: #6B7280; margin-bottom: 10px; font-size: 14px; }
        .question { font-size: 48px; font-weight: bold; color: #1F2937; margin-bottom: 15px; }
        .feedback { font-size: 24px; font-weight: bold; min-height: 30px; margin-bottom: 15px; }
        .feedback.correct { color: #22C55E; }
        .feedback.wrong { color: #EF4444; }
        .falling-area { position: relative; height: 400px; background: linear-gradient(to bottom, #DBEAFE, #BFDBFE); border-radius: 20px; border: 4px solid #60A5FA; overflow: hidden; }
        .falling-answer { position: absolute; width: 70px; height: 70px; background: white; border: 4px solid #60A5FA; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #3B82F6; cursor: pointer; transition: transform 0.1s; animation: fall 6s linear forwards; margin-left: -35px; }
        .falling-answer:nth-child(1) { left: 20%; }
        .falling-answer:nth-child(2) { left: 40%; }
        .falling-answer:nth-child(3) { left: 60%; }
        .falling-answer:nth-child(4) { left: 80%; }
        .falling-answer:hover { transform: scale(1.1); }
        .falling-answer:active { transform: scale(0.95); }
        @keyframes fall { from { top: -100px; opacity: 1; } to { top: 100%; opacity: 1; } }
        .btn { padding: 15px 30px; border: none; border-radius: 15px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(45deg, #264bb1,#264bb1); color: white; box-shadow: 0 5px 15px rgba(99, 99, 241, 0.3); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-success { background: linear-gradient(45deg, #22C55E, #16A34A); color: white; }
        .btn-warning { background: linear-gradient(45deg, #EAB308, #CA8A04); color: black; }
        .btn-share { background: linear-gradient(45deg, #A855F7, #922dd1); color: white; }
        .button-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .button-row { display: flex; gap: 10px; }
        .button-row .btn { flex: 1; }
        .result-time { font-size: 28px; font-weight: bold; color: #22C55E; margin: 15px 0; }
        .leaderboard-screen { padding: 30px; }
        .leaderboard-title { font-size: 24px; font-weight: bold; color: #1F2937; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .leaderboard-list { margin-bottom: 20px; max-height: 500px; overflow-y: auto; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 8px; border-radius: 12px; border: 1px solid #E5E7EB; }
.leaderboard-item.rank-1 { 
    background: linear-gradient(135deg, #FFD700, #FFA500); 
    border: 2px solid #CC8800; 
    color: #000000;
}
.leaderboard-item.rank-2 { 
    background: linear-gradient(135deg, #C0C0C0, #A8A8A8); 
    border: 2px solid #808080; 
    color: #000000;
}
.leaderboard-item.rank-3 { 
    background: linear-gradient(135deg, #CD7F32, #B8860B); 
    border: 2px solid #8B6914; 
    color: #000000;
}
        .leaderboard-left { display: flex; align-items: center; gap: 15px; }
        .rank-icon { font-size: 28px; }
        .player-info .player-name { font-weight: bold; color: #1F2937; }
        .player-info .player-time { font-size: 14px; color: #122854; }
        .player-info .player-address { font-size: 12px; color: #9CA3AF; font-family: monospace; }
        .empty-leaderboard { text-align: center; padding: 40px; color: #6B7280; }
        .hidden { display: none !important; }
        .success-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px 30px; border-radius: 15px; font-size: 18px; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 10000; text-align: center; max-width: 90%; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #6366F1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 600px) { .game-container { max-width: 100%; } .question { font-size: 36px; } .falling-area { height: 350px; } .game-title { font-size: 20px; } .header-avatar { width: 70px; height: 70px; font-size: 40px; } }
    </style>
</head>
<body>
    <audio id="correctSound" preload="auto"><source src="sounds/correct.mp3" type="audio/mpeg"></audio>
    <audio id="wrongSound" preload="auto"><source src="sounds/wrong.mp3" type="audio/mpeg"></audio>
    <audio id="winSound" preload="auto"><source src="sounds/win.mp3" type="audio/mpeg"></audio>
    
    <div class="game-container">
        <div class="game-header">
            <div class="header-top">
                <div class="game-title-section">
                    <div class="header-avatar" id="headerAvatar">?</div>
                    <div class="game-title"> Quick Math </div>
                </div>
                <button class="leaderboard-btn" onclick="toggleLeaderboard()">Leaderboard</button>
            </div>
            <div class="stats"><div id="timerDisplay" class="hidden">‚è±Ô∏è <span id="timer">0.00s</span></div></div>
            <div class="progress-boxes">
                <div class="progress-box inactive">1</div>
                <div class="progress-box inactive">2</div>
                <div class="progress-box inactive">3</div>
                <div class="progress-box inactive">4</div>
            </div>
        </div>

        <div class="game-content" id="startScreen">
            <div class="start-screen">
                <div class="game-icon">üìü</div>
                <h2 style="font-size: 28px; margin-bottom: 15px; color: #1F2937;">‚è±Ô∏è Math vs Time - Go!</h2>
                <p style="color: #011b4c; margin-bottom: 10px;">Answer 4 questions correctly to win.</p>
                <p style="color: #1a1a1b; font-size: 14px; margin-bottom: 20px;">üåê Beat the clock, own the leaderboard!</p>
                <div class="wallet-container">
                    <div class="wallet-status">
                        <div class="wallet-indicator" id="walletIndicator"></div>
                        <span id="walletStatus">Not Connected</span>
                    </div>
                    <div id="walletInfo" style="display: none;"><div id="walletAddress"></div></div>
                    <button class="btn btn-primary" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
                </div>
                <button class="btn btn-primary" id="playBtn" onclick="startGame()" disabled>Start Game</button>
            </div>
        </div>

        <div class="game-content hidden" id="gameScreen">
            <div class="game-screen">
                <div class="question-number" id="questionNumber">Question 1 of 4</div>
                <div class="question" id="question">5 + 3 = ?</div>
                <div class="feedback" id="feedback"></div>
                <div class="falling-area" id="fallingArea"></div>
            </div>
        </div>

        <div class="game-content hidden" id="resultScreen">
            <div class="result-screen">
                <div class="game-icon" id="resultIcon">üèÜ</div>
                <h2 style="font-size: 32px; margin-bottom: 15px; color: #1F2937;" id="resultTitle">You Win!</h2>
                <p style="color: #6B7280; margin-bottom: 10px;" id="resultText">Perfect Score! 4/4 correct! üéâ</p>
                <div class="result-time" id="resultTime">‚è±Ô∏è 0.00s</div>
                <div class="button-group">
                    <button class="btn btn-success" style="width: 100%;" onclick="submitScoreOnChain()">üìä Save to Leaderboard</button>
                    <button class="btn btn-warning" style="width: 100%;" onclick="claimRewardOnChain()">üí∞ Claim Reward</button>
                    <button class="btn btn-primary" style="width: 100%;" onclick="showLeaderboard()">üèÜ View Leaderboard</button>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="playAgain()">Play Again</button>
                        <button class="btn btn-share" onclick="shareGame()">üì± Share</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="leaderboard-screen hidden" id="leaderboardScreen">
            <h2 class="leaderboard-title">‚è±Ô∏è Top 50 Fastest Players</h2>
            <div class="leaderboard-list" id="leaderboardList">
                <div class="empty-leaderboard"><p style="font-size: 18px; margin-bottom: 5px;">Loading leaderboard...</p><div class="loading-spinner"></div></div>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="hideLeaderboard()">Back to Game</button>
        </div>
    </div>

    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        import { createAppKit } from 'https://esm.sh/@reown/appkit';
        import { EthersAdapter } from 'https://esm.sh/@reown/appkit-adapter-ethers';
        import { base } from 'https://esm.sh/@reown/appkit/networks';
        import { ethers } from 'https://esm.sh/ethers@6.7.0';
        import { createConfig, connect, writeContract, readContract, getAccount, waitForTransactionReceipt, watchAccount, http } from 'https://esm.sh/@wagmi/core';
        import { base as wagmiBase } from 'https://esm.sh/@wagmi/core/chains';
        import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector';

        let isFarcasterEnvironment = false, userProfile = null, farcasterFID = null, appKitModal = null, ethersProvider = null;
        window.walletConfig = null; window.isWalletConnected = false; window.currentAccount = null;

        const CONTRACT_ADDRESS = '0xadd4fb9ef92b6de07c970d9a1a2ee9f9f175de54';
        const NEYNAR_API_KEY = '8BF81B8C-C491-4735-8E1C-FC491FF048D4';
        const REOWN_PROJECT_ID = 'e0dd881bad824ac3418617434a79f917';
        const CONTRACT_ABI = [{"inputs":[{"internalType":"uint256","name":"farcasterFID","type":"uint256"}],"name":"startGame","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"completionTime","type":"uint256"},{"internalType":"uint256","name":"farcasterFID","type":"uint256"},{"internalType":"uint256","name":"questionsCorrect","type":"uint256"}],"name":"submitScore","outputs":[{"internalType":"uint256","name":"position","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"farcasterFID","type":"uint256"},{"internalType":"uint256","name":"questionsCorrect","type":"uint256"}],"name":"claimReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"name":"getTopPlayers","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"farcasterFID","type":"uint256"},{"internalType":"uint256","name":"completionTime","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct MathDropGame.LeaderboardEntry[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"player","type":"address"}],"name":"getPlayerStats","outputs":[{"internalType":"uint256","name":"bestTime","type":"uint256"},{"internalType":"uint256","name":"totalGames","type":"uint256"},{"internalType":"uint256","name":"totalRewardsClaimed","type":"uint256"},{"internalType":"uint256","name":"lastPlayTimestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"farcasterFID","type":"uint256"}],"name":"getRemainingClaimsForFID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getContractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getRewardAmount","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"pure","type":"function"}];

        async function detectEnvironment() {
            try { const context = await sdk.context; if (context?.user?.fid) { isFarcasterEnvironment = true; console.log('‚úÖ Farcaster'); return true; } } catch (error) {}
            isFarcasterEnvironment = false; console.log('üåê Standalone - Reown'); return false;
        }

        async function fetchFarcasterProfile() {
            try {
                const context = await sdk.context;
                if (context?.user?.fid) {
                    farcasterFID = context.user.fid;
                    const response = await fetch(`https://api.neynar.com/v2/farcaster/user/bulk?fids=${farcasterFID}`, { method: 'GET', headers: { 'Accept': 'application/json', 'api_key': NEYNAR_API_KEY }});
                    if (response.ok) { const data = await response.json(); if (data.users && data.users.length > 0) { userProfile = data.users[0]; updateProfileUI(); } }
                } else { userProfile = { display_name: "Demo Player", username: "player", pfp_url: null }; farcasterFID = 0; updateProfileUI(); }
            } catch (error) { userProfile = { display_name: "Demo Player", username: "player", pfp_url: null }; farcasterFID = 0; updateProfileUI(); }
        }

        function updateProfileUI() {
            if (!userProfile) return;
            const headerAvatar = document.getElementById('headerAvatar');
            if (userProfile.pfp_url) { headerAvatar.innerHTML = `<img src="${userProfile.pfp_url}" alt="Avatar">`; }
            else { headerAvatar.textContent = userProfile.display_name ? userProfile.display_name.charAt(0).toUpperCase() : '?'; }
            headerAvatar.classList.add('show');
        }

        async function initializeFarcasterWallet() {
            try {
                window.walletConfig = createConfig({ chains: [wagmiBase], connectors: [farcasterMiniApp()], transports: { [wagmiBase.id]: http() }});
                watchAccount(window.walletConfig, { onChange: (account) => updateWalletUI(account) });
                const account = getAccount(window.walletConfig);
                if (account.isConnected) { updateWalletUI(account); }
                else { try { await connect(window.walletConfig, { connector: farcasterMiniApp() }); updateWalletUI(getAccount(window.walletConfig)); } catch (error) { updateWalletUI(getAccount(window.walletConfig)); } }
            } catch (error) { console.error('Failed to initialize Farcaster wallet:', error); }
        }

        async function initializeReownWallet() {
            try {
                const adapter = new EthersAdapter();
                appKitModal = createAppKit({ 
                    adapters: [adapter], 
                    projectId: REOWN_PROJECT_ID, 
                    networks: [base], 
                    metadata: { 
                        name: 'Quick Math', 
                        description: 'Math game on Base', 
                        url: window.location.origin, 
                        icons: ['https://quick-mathquiz.vercel.app/image.png'] 
                    }, 
                    features: { analytics: false }
                });

                // Subscribe to state changes
                const unsubscribe = appKitModal.subscribeState((state) => {
                    console.log('AppKit state:', state);
                    
                    // Modal just closed - check if we're connected
                    if (state.open === false && !state.loading) {
                        setTimeout(() => checkConnection(), 500);
                    }
                });

                // Function to check connection status
                async function checkConnection() {
                    try {
                        const walletProvider = appKitModal.getWalletProvider();
                        if (walletProvider) {
                            ethersProvider = new ethers.BrowserProvider(walletProvider);
                            const signer = await ethersProvider.getSigner();
                            const address = await signer.getAddress();
                            
                            if (address) {
                                console.log('‚úÖ Wallet connected:', address);
                                window.currentAccount = { address: address, isConnected: true };
                                window.isWalletConnected = true;
                                updateWalletUI({ isConnected: true, address: address });
                                return true;
                            }
                        }
                    } catch (error) {
                        console.log('No wallet connected');
                    }
                    
                    // Not connected
                    window.currentAccount = null;
                    window.isWalletConnected = false;
                    ethersProvider = null;
                    updateWalletUI({ isConnected: false });
                    return false;
                }

                // Check initial state after a short delay
                setTimeout(() => checkConnection(), 1000);

                console.log('‚úÖ Reown initialized');
            } catch (error) { 
                console.error('Failed to initialize Reown:', error); 
            }
        }

        function updateWalletUI(account) {
            if (account && account.isConnected && account.address) {
                window.isWalletConnected = true; window.currentAccount = account;
                document.getElementById('walletIndicator').classList.add('connected');
                document.getElementById('walletStatus').textContent = 'Connected';
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('walletAddress').textContent = `${account.address.slice(0, 6)}...${account.address.slice(-4)}`;
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('playBtn').disabled = false;
            } else {
                window.isWalletConnected = false; window.currentAccount = null;
                document.getElementById('walletIndicator').classList.remove('connected');
                document.getElementById('walletStatus').textContent = 'Not Connected';
                document.getElementById('walletInfo').style.display = 'none';
                document.getElementById('connectBtn').style.display = 'inline-block';
                document.getElementById('playBtn').disabled = true;
            }
        }

        window.userProfile = userProfile; window.getFarcasterFID = () => farcasterFID;

        window.connectWallet = async function() {
            try {
                console.log('Connect wallet clicked');
                if (isFarcasterEnvironment) { 
                    await connect(window.walletConfig, { connector: farcasterMiniApp() }); 
                    updateWalletUI(getAccount(window.walletConfig)); 
                }
                else { 
                    console.log('Opening Reown modal...');
                    await appKitModal.open();
                    
                    // After modal closes, check connection
                    const checkInterval = setInterval(async () => {
                        const state = appKitModal.getState();
                        
                        // Modal is closed and not loading
                        if (state.open === false && !state.loading) {
                            clearInterval(checkInterval);
                            
                            try {
                                const walletProvider = appKitModal.getWalletProvider();
                                if (walletProvider) {
                                    ethersProvider = new ethers.BrowserProvider(walletProvider);
                                    const signer = await ethersProvider.getSigner();
                                    const address = await signer.getAddress();
                                    
                                    if (address) {
                                        console.log('‚úÖ Connected:', address);
                                        window.currentAccount = { address: address, isConnected: true };
                                        window.isWalletConnected = true;
                                        updateWalletUI({ isConnected: true, address: address });
                                    }
                                }
                            } catch (error) {
                                console.log('User closed modal without connecting');
                            }
                        }
                    }, 500);
                    
                    // Clear interval after 10 seconds to prevent memory leak
                    setTimeout(() => clearInterval(checkInterval), 10000);
                }
            } catch (error) { 
                console.error('Connect wallet error:', error);
                showSuccessMessage('‚ùå Failed to connect wallet'); 
            }
        };

        window.startGame = async function() {
            if (!window.isWalletConnected) { alert('Please connect your wallet first!'); return; }
            try {
                const playBtn = document.getElementById('playBtn');
                playBtn.disabled = true;
                playBtn.innerHTML = 'Confirming... <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px;"></div>';
                const fid = window.getFarcasterFID();
                if (isFarcasterEnvironment) { 
                    const hash = await writeContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'startGame', args: [BigInt(fid || 0)] }); 
                    const receipt = await waitForTransactionReceipt(window.walletConfig, { hash }); 
                    if (receipt.status !== 'success') throw new Error('Transaction failed'); 
                }
                else { 
                    // Ensure we have the provider
                    if (!ethersProvider) {
                        const walletProvider = appKitModal.getWalletProvider();
                        if (walletProvider) {
                            ethersProvider = new ethers.BrowserProvider(walletProvider);
                        } else {
                            throw new Error('No wallet provider available');
                        }
                    }
                    const signer = await ethersProvider.getSigner(); 
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer); 
                    const tx = await contract.startGame(0); 
                    await tx.wait(); 
                }
                window.gameState = 'playing'; window.currentQuestion = 0; window.correctAnswers = [false, false, false, false]; window.totalCorrectAnswers = 0;
                document.getElementById('startScreen').classList.add('hidden'); document.getElementById('gameScreen').classList.remove('hidden'); document.getElementById('timerDisplay').classList.remove('hidden');
                window.updateProgressBoxes(); window.updateQuestionNumber(); window.gameStartTime = Date.now(); window.currentGameTime = 0;
                window.timerInterval = setInterval(() => { window.currentGameTime = Date.now() - window.gameStartTime; document.getElementById('timer').textContent = window.formatTime(window.currentGameTime); }, 100);
                window.generateQuestion();
            } catch (error) { 
                console.error('Start game error:', error);
                const playBtn = document.getElementById('playBtn'); 
                playBtn.disabled = false; 
                playBtn.textContent = 'Start Game'; 
                showSuccessMessage('‚ùå Failed to start game'); 
            }
        };

        window.submitScoreOnChain = async function() {
            if (!window.isWalletConnected || !window.currentAccount) { showSuccessMessage('üîó Please connect your wallet first!'); return; }
            if (window.totalCorrectAnswers !== 4) { showSuccessMessage('‚ùå Must complete all 4 questions correctly!'); return; }
            const fid = window.getFarcasterFID();
            try {
                let playerStats;
                if (isFarcasterEnvironment) { 
                    playerStats = await readContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'getPlayerStats', args: [window.currentAccount.address] }); 
                }
                else { 
                    if (!ethersProvider) {
                        const walletProvider = appKitModal.getWalletProvider();
                        if (walletProvider) ethersProvider = new ethers.BrowserProvider(walletProvider);
                    }
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, ethersProvider); 
                    playerStats = await contract.getPlayerStats(window.currentAccount.address); 
                }
                const previousBestTime = Number(playerStats[0]);
                if (previousBestTime > 0 && window.currentGameTime >= previousBestTime) { showSuccessMessage(`‚ö†Ô∏è Not better than your best time (${window.formatTime(previousBestTime)})`); return; }
                showSuccessMessage('üìù Submitting score...');
                if (isFarcasterEnvironment) { 
                    const hash = await writeContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'submitScore', args: [BigInt(window.currentGameTime), BigInt(fid || 0), BigInt(window.totalCorrectAnswers)] }); 
                    const receipt = await waitForTransactionReceipt(window.walletConfig, { hash }); 
                    if (receipt.status !== 'success') throw new Error('Transaction failed'); 
                }
                else { 
                    const signer = await ethersProvider.getSigner(); 
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer); 
                    const tx = await contract.submitScore(window.currentGameTime, 0, window.totalCorrectAnswers); 
                    await tx.wait(); 
                }
                try {
                    let topPlayers;
                    if (isFarcasterEnvironment) { topPlayers = await readContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'getTopPlayers', args: [BigInt(50)] }); }
                    else { const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, ethersProvider); topPlayers = await contract.getTopPlayers(50); }
                    const bestTimesMap = new Map(); topPlayers.forEach(entry => { const address = entry.player.toLowerCase(); if (!bestTimesMap.has(address) || Number(entry.completionTime) < Number(bestTimesMap.get(address).completionTime)) { bestTimesMap.set(address, entry); } });
                    const uniquePlayers = Array.from(bestTimesMap.values()).sort((a, b) => Number(a.completionTime) - Number(b.completionTime)); const playerAddress = window.currentAccount.address.toLowerCase(); const rankIndex = uniquePlayers.findIndex(p => p.player.toLowerCase() === playerAddress);
                    if (rankIndex !== -1) { window.playerRank = rankIndex + 1; }
                } catch (error) {}
                showSuccessMessage(previousBestTime === 0 ? 'üéâ First score submitted!' : 'üéâ New best time!');
                if (!document.getElementById('leaderboardScreen').classList.contains('hidden')) { await window.loadOnChainLeaderboard(); }
            } catch (error) { 
                console.error('Submit score error:', error);
                showSuccessMessage('‚ùå Failed to submit score'); 
            }
        };

        window.claimRewardOnChain = async function() {
            if (!window.isWalletConnected || !window.currentAccount) { showSuccessMessage('üîó Please connect your wallet first!'); return; }
            if (window.totalCorrectAnswers !== 4) { showSuccessMessage('‚ùå Must complete all 4 questions correctly!'); return; }
            const fid = window.getFarcasterFID();
            try {
                showSuccessMessage('‚è≥ Checking eligibility...');
                let remainingClaims, rewardAmount, contractBalance;
                if (isFarcasterEnvironment) {
                    remainingClaims = await readContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'getRemainingClaimsForFID', args: [BigInt(fid || 0)] });
                    rewardAmount = await readContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'getRewardAmount' });
                    contractBalance = await readContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'getContractBalance' });
                } else {
                    if (!ethersProvider) {
                        const walletProvider = appKitModal.getWalletProvider();
                        if (walletProvider) ethersProvider = new ethers.BrowserProvider(walletProvider);
                    }
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, ethersProvider);
                    remainingClaims = await contract.getRemainingClaimsForFID(0);
                    rewardAmount = await contract.getRewardAmount();
                    contractBalance = await contract.getContractBalance();
                }
                if (Number(remainingClaims) === 0) { showSuccessMessage('‚ùå You already claimed today!'); return; }
                if (Number(contractBalance) < Number(rewardAmount)) { showSuccessMessage('üòî Prize pool empty!'); return; }
                showSuccessMessage('üí∞ Claiming reward...');
                if (isFarcasterEnvironment) { 
                    const hash = await writeContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'claimReward', args: [BigInt(fid || 0), BigInt(window.totalCorrectAnswers)] }); 
                    const receipt = await waitForTransactionReceipt(window.walletConfig, { hash }); 
                    if (receipt.status !== 'success') throw new Error('Transaction failed'); 
                }
                else { 
                    const signer = await ethersProvider.getSigner(); 
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer); 
                    const tx = await contract.claimReward(0, window.totalCorrectAnswers); 
                    await tx.wait(); 
                }
                showSuccessMessage('üéâ ETH sent to your wallet on Base!');
            } catch (error) { 
                console.error('Claim reward error:', error);
                showSuccessMessage('‚ùå Failed to claim reward'); 
            }
        };

        window.loadOnChainLeaderboard = async function() {
            try {
                let topPlayers;
                if (isFarcasterEnvironment && window.walletConfig) { topPlayers = await readContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'getTopPlayers', args: [BigInt(50)] }); }
                else if (ethersProvider) { const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, ethersProvider); topPlayers = await contract.getTopPlayers(50); }
                else { return; }
                displayOnChainLeaderboard(topPlayers);
            } catch (error) { document.getElementById('leaderboardList').innerHTML = `<div class="empty-leaderboard"><p>Failed to load leaderboard</p></div>`; }
        };

        window.fetchPlayerRank = async function() {
            if (!window.isWalletConnected || !window.currentAccount) return null;
            try {
                let topPlayers;
                if (isFarcasterEnvironment && window.walletConfig) { topPlayers = await readContract(window.walletConfig, { address: CONTRACT_ADDRESS, abi: CONTRACT_ABI, functionName: 'getTopPlayers', args: [BigInt(50)] }); }
                else if (ethersProvider) { const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, ethersProvider); topPlayers = await contract.getTopPlayers(50); }
                const bestTimesMap = new Map(); topPlayers.forEach(entry => { const address = entry.player.toLowerCase(); if (!bestTimesMap.has(address) || Number(entry.completionTime) < Number(bestTimesMap.get(address).completionTime)) { bestTimesMap.set(address, entry); } });
                const uniquePlayers = Array.from(bestTimesMap.values()).sort((a, b) => Number(a.completionTime) - Number(b.completionTime)); const playerAddress = window.currentAccount.address.toLowerCase(); const rankIndex = uniquePlayers.findIndex(p => p.player.toLowerCase() === playerAddress);
                return rankIndex !== -1 ? rankIndex + 1 : null;
            } catch (error) { return null; }
        };

        async function displayOnChainLeaderboard(players) {
            const listDiv = document.getElementById('leaderboardList');
            if (!players || players.length === 0) { listDiv.innerHTML = `<div class="empty-leaderboard"><p>No scores yet!</p></div>`; return; }
            const bestTimesMap = new Map(); players.forEach(entry => { const address = entry.player.toLowerCase(); if (!bestTimesMap.has(address) || Number(entry.completionTime) < Number(bestTimesMap.get(address).completionTime)) { bestTimesMap.set(address, entry); } });
            const uniquePlayers = Array.from(bestTimesMap.values()).sort((a, b) => Number(a.completionTime) - Number(b.completionTime)).slice(0, 50);
            const fids = [...new Set(uniquePlayers.map(p => Number(p.farcasterFID)).filter(fid => fid > 0))]; let profiles = {};
            if (fids.length > 0) {
                try { const response = await fetch(`https://api.neynar.com/v2/farcaster/user/bulk?fids=${fids.join(',')}`, { method: 'GET', headers: { 'Accept': 'application/json', 'api_key': NEYNAR_API_KEY }}); if (response.ok) { const data = await response.json(); data.users.forEach(user => { profiles[user.fid] = user; }); } } catch (error) {}
            }
            listDiv.innerHTML = uniquePlayers.map((entry, idx) => {
                const rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : '';
                const rankIcon = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`;
                const fid = Number(entry.farcasterFID); const profile = profiles[fid];
                let avatarHtml, displayName;
                if (profile && profile.pfp_url) { avatarHtml = `<img src="${profile.pfp_url}" style="width: 40px; height: 40px; border-radius: 8px; margin-right: 10px;">`; displayName = profile.display_name || profile.username || 'Player'; }
                else { const letter = entry.player.substring(2, 3).toUpperCase(); avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 8px; background: #374151; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: white; font-weight: bold;">${letter}</div>`; displayName = fid > 0 ? `FID ${fid}` : 'Anonymous'; }
                return `<div class="leaderboard-item ${rankClass}"><div class="leaderboard-left"><div class="rank-icon">${rankIcon}</div>${avatarHtml}<div class="player-info"><div class="player-name">${displayName}</div><div class="player-time">${window.formatTime(Number(entry.completionTime))}</div><div class="player-address">${entry.player.substring(0, 6)}...${entry.player.substring(38)}</div></div></div></div>`;
            }).join('');
        }

        function showSuccessMessage(message) {
            const existingPopup = document.querySelector('.success-popup'); if (existingPopup) existingPopup.remove();
            const popup = document.createElement('div'); popup.className = 'success-popup'; popup.textContent = message; document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 4000);
        }

        (async () => { try { await detectEnvironment(); if (isFarcasterEnvironment) { if (sdk?.actions?.addMiniApp) await sdk.actions.addMiniApp(); sdk.actions.ready({ disableNativeGestures: true }); await fetchFarcasterProfile(); await initializeFarcasterWallet(); } else { await initializeReownWallet(); } } catch (err) {} })();
    </script>

    <script>
        window.gameState = 'ready'; window.currentQuestion = 0; window.correctAnswers = [false, false, false, false]; window.correctAnswer = 0; window.isAnswered = false; window.gameStartTime = 0; window.currentGameTime = 0; window.timerInterval = null; window.fallTimeout = null; window.totalCorrectAnswers = 0; window.playerRank = null;

        window.generateQuestion = function() {
            const a = Math.floor(Math.random() * 10) + 1; const b = Math.floor(Math.random() * 10) + 1; const operations = ['+', '-', '√ó']; const op = operations[Math.floor(Math.random() * 3)];
            let correct, questionText;
            if (op === '+') { correct = a + b; questionText = `${a} + ${b}`; }
            else if (op === '-') { const [num1, num2] = a > b ? [a, b] : [b, a]; correct = num1 - num2; questionText = `${num1} - ${num2}`; }
            else { correct = a * b; questionText = `${a} √ó ${b}`; }
            window.correctAnswer = correct; document.getElementById('question').textContent = `${questionText} = ?`;
            const wrongAnswers = [correct + Math.floor(Math.random() * 5) + 1, correct - Math.floor(Math.random() * 5) - 1, correct + Math.floor(Math.random() * 10) + 5].filter(ans => ans !== correct && ans > 0);
            const allAnswers = [correct, ...wrongAnswers.slice(0, 3)].sort(() => Math.random() - 0.5); window.createFallingAnswers(allAnswers);
        };

        window.createFallingAnswers = function(answers) {
            const fallingArea = document.getElementById('fallingArea'); fallingArea.innerHTML = ''; window.isAnswered = false;
            answers.forEach((ans) => { const answerDiv = document.createElement('div'); answerDiv.className = 'falling-answer'; answerDiv.textContent = ans; answerDiv.onclick = () => window.handleAnswerClick(ans); fallingArea.appendChild(answerDiv); });
            window.fallTimeout = setTimeout(() => { if (!window.isAnswered) window.handleMiss(); }, 6000);
        };

        window.handleAnswerClick = function(selected) {
            if (window.isAnswered) return; window.isAnswered = true; clearTimeout(window.fallTimeout);
            if (selected === window.correctAnswer) {
                const correctSound = document.getElementById('correctSound'); correctSound.currentTime = 0; correctSound.play().catch(e => {});
                window.correctAnswers[window.currentQuestion] = true; window.totalCorrectAnswers++; window.updateProgressBoxes(); window.showFeedback('üéâ Correct!', 'correct');
                if (window.currentQuestion === 3) { clearInterval(window.timerInterval); setTimeout(() => window.showWinScreen(), 800); }
                else { setTimeout(() => { window.currentQuestion++; window.updateQuestionNumber(); window.generateQuestion(); document.getElementById('feedback').textContent = ''; }, 800); }
            } else { const wrongSound = document.getElementById('wrongSound'); wrongSound.currentTime = 0; wrongSound.play().catch(e => {}); window.showFeedback('‚ùå Wrong!', 'wrong'); clearInterval(window.timerInterval); setTimeout(() => window.showGameOver(), 800); }
        };

        window.handleMiss = function() { const wrongSound = document.getElementById('wrongSound'); wrongSound.currentTime = 0; wrongSound.play().catch(e => {}); window.showFeedback('‚è±Ô∏è Too slow!', 'wrong'); clearInterval(window.timerInterval); setTimeout(() => window.showGameOver(), 800); };
        window.showFeedback = function(text, type) { const feedback = document.getElementById('feedback'); feedback.textContent = text; feedback.className = `feedback ${type}`; };
        window.updateProgressBoxes = function() { const boxes = document.querySelectorAll('.progress-box'); boxes.forEach((box, idx) => { if (window.correctAnswers[idx]) { box.className = 'progress-box correct'; box.innerHTML = '‚úì'; } else if (idx === window.currentQuestion) { box.className = 'progress-box active'; box.textContent = idx + 1; } else { box.className = 'progress-box inactive'; box.textContent = idx + 1; } }); };
        window.updateQuestionNumber = function() { document.getElementById('questionNumber').textContent = `Question ${window.currentQuestion + 1} of 4`; };
        window.formatTime = function(ms) { const seconds = Math.floor(ms / 1000); const milliseconds = Math.floor((ms % 1000) / 10); return `${seconds}.${milliseconds.toString().padStart(2, '0')}s`; };

        window.showWinScreen = async function() {
            const winSound = document.getElementById('winSound'); winSound.currentTime = 0; winSound.play().catch(e => {});
            document.getElementById('gameScreen').classList.add('hidden'); document.getElementById('resultScreen').classList.remove('hidden'); document.getElementById('timerDisplay').classList.add('hidden');
            document.getElementById('resultIcon').textContent = 'üèÜ'; document.getElementById('resultTitle').textContent = 'You Win!'; document.getElementById('resultText').textContent = 'Perfect Score! 4/4 correct! üéâ'; document.getElementById('resultTime').textContent = `‚è±Ô∏è ${window.formatTime(window.currentGameTime)}`;
            const submitBtn = document.querySelector('[onclick="submitScoreOnChain()"]'); const claimBtn = document.querySelector('[onclick="claimRewardOnChain()"]'); const shareBtn = document.querySelector('[onclick="shareGame()"]');
            if (submitBtn) submitBtn.style.display = 'block'; if (claimBtn) claimBtn.style.display = 'block'; if (shareBtn) shareBtn.style.display = 'inline-block';
            if (window.fetchPlayerRank) { window.playerRank = await window.fetchPlayerRank(); }
        };

        window.showGameOver = function() {
            document.getElementById('gameScreen').classList.add('hidden'); document.getElementById('resultScreen').classList.remove('hidden'); document.getElementById('timerDisplay').classList.add('hidden');
            document.getElementById('resultIcon').textContent = 'üí•'; document.getElementById('resultTitle').textContent = 'Game Over!'; document.getElementById('resultText').textContent = `You got ${window.correctAnswers.filter(Boolean).length} out of 4 correct`; document.getElementById('resultTime').classList.add('hidden');
            const submitBtn = document.querySelector('[onclick="submitScoreOnChain()"]'); const claimBtn = document.querySelector('[onclick="claimRewardOnChain()"]'); const shareBtn = document.querySelector('[onclick="shareGame()"]');
            if (submitBtn) submitBtn.style.display = 'none'; if (claimBtn) claimBtn.style.display = 'none'; if (shareBtn) shareBtn.style.display = 'none';
        };

        window.playAgain = function() {
            window.gameState = 'ready'; window.playerRank = null; document.getElementById('resultScreen').classList.add('hidden'); document.getElementById('startScreen').classList.remove('hidden'); document.getElementById('resultTime').classList.remove('hidden');
            const playBtn = document.getElementById('playBtn'); playBtn.disabled = false; playBtn.textContent = 'Start Game';
            const boxes = document.querySelectorAll('.progress-box'); boxes.forEach((box, idx) => { box.className = 'progress-box inactive'; box.textContent = idx + 1; });
        };

        window.showLeaderboard = function() { document.getElementById('resultScreen').classList.add('hidden'); document.getElementById('leaderboardScreen').classList.remove('hidden'); window.loadOnChainLeaderboard(); };

        window.toggleLeaderboard = function() {
            const leaderboardScreen = document.getElementById('leaderboardScreen'); const startScreen = document.getElementById('startScreen'); const gameScreen = document.getElementById('gameScreen'); const resultScreen = document.getElementById('resultScreen');
            if (leaderboardScreen.classList.contains('hidden')) { leaderboardScreen.classList.remove('hidden'); startScreen.classList.add('hidden'); gameScreen.classList.add('hidden'); resultScreen.classList.add('hidden'); window.loadOnChainLeaderboard(); }
            else { window.hideLeaderboard(); }
        };

        window.hideLeaderboard = function() { document.getElementById('leaderboardScreen').classList.add('hidden'); document.getElementById('startScreen').classList.remove('hidden'); window.gameState = 'ready'; const playBtn = document.getElementById('playBtn'); playBtn.disabled = false; playBtn.textContent = 'Start Game'; };

        window.shareGame = function() {
            let shareText = `üî• Just completed Quick Math in ${window.formatTime(window.currentGameTime)}!\n\n`;
            if (window.playerRank !== null) {
                if (window.playerRank === 1) { shareText += 'ü•á Rank #1\n'; }
                else if (window.playerRank === 2) { shareText += 'ü•à Rank #2\n'; }
                else if (window.playerRank === 3) { shareText += 'ü•â Rank #3\n'; }
                else { shareText += `üèÜ Rank #${window.playerRank}\n`; }
            }
            shareText += 'üìã 4/4 correct - Score submitted onchain.\n‚û§ Claimed my reward.\nü•∑üèª Beat my time if you can!';
            const encodedText = encodeURIComponent(shareText); const shareUrl = encodeURIComponent(window.location.href); const castUrl = `https://farcaster.xyz/~/compose?text=${encodedText}&embeds[]=${shareUrl}`;
            window.open(castUrl, '_blank');
        };
    </script>
</body>
</html>