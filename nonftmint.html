<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Math</title>
    
    <meta name="fc:miniapp" content='{
        "version":"1",
        "imageUrl":"https://quick-mathquiz.vercel.app/image.png",
        "button":{
            "title":"Play Quick Math & Earn!",
            "action":{
                "type":"launch_frame",
                "name":"Quick Math",
                "url":"https://quick-mathquiz.vercel.app",
                "splashImageUrl":"https://quick-mathquiz.vercel.app/splash.png",
                "splashBackgroundColor":"#cce5ff"
            }
        }
    }' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #87CEEB;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0px;
        }

        .game-container {
            background: rgb(201, 221, 253);
            border-radius: 0px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            max-width: 0px;
            width: 100%;
            overflow: hidden;
            height: 100vh;
            overflow-y: auto;
        }

        .game-header {
            background: #264bb1;
            color: white;
            padding: 25px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .game-title-section {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .header-avatar {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            background: #444;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 25px;
            font-weight: bold;
            overflow: hidden;
            border: 2px solid #ffffff;
        }

        .header-avatar.show {
            display: flex;
        }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .game-title {
            font-size: 24px;
            font-weight: bold;
            white-space: nowrap;
        }

        .leaderboard-btn {
            background: #EAB308;
            color: black;
            border: none;
            padding: 10px 10px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .leaderboard-btn:hover {
            background: #CA8A04;
            transform: scale(1.05);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .progress-boxes {
            display: flex;
            gap: 8px;
        }

        .progress-box {
            flex: 1;
            height: 48px;
            border-radius: 10px;
            border: 2px solid #a2a2a2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .progress-box.correct {
            background: #22C55E;
            border-color: #cfffe1;
            color: white;
        }

        .progress-box.active {
            background: #EAB308;
            border-color: #CA8A04;
            color: white;
        }

        .progress-box.inactive {
            background: #374151;
            border-color: #e2e2e2;
            color: #e6eeff;
        }

        .game-content {
            padding: 30px;
        }

        .start-screen, .game-screen, .result-screen {
            text-align: center;
        }

        .game-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .wallet-container {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .wallet-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #1F2937;
        }

        .wallet-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .wallet-indicator.connected {
            background: #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #walletAddress {
            font-family: monospace;
            margin: 8px 0;
            font-size: 13px;
            color: #6B7280;
        }

        .game-screen .question-number {
            color: #6B7280;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .question {
            font-size: 48px;
            font-weight: bold;
            color: #1F2937;
            margin-bottom: 15px;
        }

        .feedback {
            font-size: 24px;
            font-weight: bold;
            min-height: 30px;
            margin-bottom: 15px;
        }

        .feedback.correct {
            color: #22C55E;
        }

        .feedback.wrong {
            color: #EF4444;
        }

        .falling-area {
            position: relative;
            height: 400px;
            background: linear-gradient(to bottom, #DBEAFE, #BFDBFE);
            border-radius: 20px;
            border: 4px solid #60A5FA;
            overflow: hidden;
        }

        .falling-answer {
            position: absolute;
            width: 70px;
            height: 70px;
            background: white;
            border: 4px solid #60A5FA;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #3B82F6;
            cursor: pointer;
            transition: transform 0.1s;
            animation: fall 6s linear forwards;
            margin-left: -35px;
        }

        .falling-answer:nth-child(1) {
            left: 20%;
        }

        .falling-answer:nth-child(2) {
            left: 40%;
        }

        .falling-answer:nth-child(3) {
            left: 60%;
        }

        .falling-answer:nth-child(4) {
            left: 80%;
        }

        .falling-answer:hover {
            transform: scale(1.1);
        }

        .falling-answer:active {
            transform: scale(0.95);
        }

        @keyframes fall {
            from {
                top: -100px;
                opacity: 1;
            }
            to {
                top: 100%;
                opacity: 1;
            }
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #264bb1,#264bb1);
            color: white;
            box-shadow: 0 5px 15px rgba(99, 99, 241, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success {
            background: linear-gradient(45deg, #22C55E, #16A34A);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #EAB308, #CA8A04);
            color: black;
        }

        .btn-share {
            background: linear-gradient(45deg, #A855F7, #922dd1);
            color: white;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .button-row {
            display: flex;
            gap: 10px;
        }

        .button-row .btn {
            flex: 1;
        }

        .result-time {
            font-size: 28px;
            font-weight: bold;
            color: #22C55E;
            margin: 15px 0;
        }

        .leaderboard-screen {
            padding: 30px;
        }

        .leaderboard-title {
            font-size: 24px;
            font-weight: bold;
            color: #1F2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-list {
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
        }

        .leaderboard-item.rank-1 {
            background: #b6d2f5ef;
            border: 2px solid #000000;
        }

        .leaderboard-item.rank-2 {
            background: #cad3e5;
            border: 2px solid #000000;
        }

        .leaderboard-item.rank-3 {
            background: #bbacdd;
            border: 2px solid #000000;
        }

        .leaderboard-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rank-icon {
            font-size: 28px;
        }

        .player-info .player-name {
            font-weight: bold;
            color: #1F2937;
        }

        .player-info .player-time {
            font-size: 14px;
            color: #122854;
        }

        .player-info .player-address {
            font-size: 12px;
            color: #9CA3AF;
            font-family: monospace;
        }

        .empty-leaderboard {
            text-align: center;
            padding: 40px;
            color: #6B7280;
        }

        .hidden {
            display: none !important;
        }

        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
            max-width: 90%;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366F1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .game-container {
                max-width: 100%;
            }

            .question {
                font-size: 36px;
            }

            .falling-area {
                height: 350px;
            }
            
            .game-title {
                font-size: 20px;
            }
            
            .header-avatar {
                width: 70px;
                height: 70px;
                font-size: 40px;
            }
        }
    </style>
</head>
<body>

  <!-- Add these audio elements -->
    <audio id="correctSound" preload="auto">
        <source src="sounds/correct.mp3" type="audio/mpeg">
    </audio>
    <audio id="wrongSound" preload="auto">
        <source src="sounds/wrong.mp3" type="audio/mpeg">
    </audio>
    <audio id="winSound" preload="auto">
        <source src="sounds/win.mp3" type="audio/mpeg">
    </audio>
    
    <div class="game-container">
        
    <div class="game-container">
        <div class="game-header">
            <div class="header-top">
                <div class="game-title-section">
                    <div class="header-avatar" id="headerAvatar">?</div>
                    <div class="game-title"> Quick Math </div>
                </div>
                <button class="leaderboard-btn" id="leaderboardBtn" onclick="toggleLeaderboard()">
                    Leaderboard
                </button>
            </div>

            <div class="stats">
                <div id="timerDisplay" class="hidden">‚è±Ô∏è <span id="timer">0.00s</span></div>
            </div>

            <div class="progress-boxes" id="progressBoxes">
                <div class="progress-box inactive">1</div>
                <div class="progress-box inactive">2</div>
                <div class="progress-box inactive">3</div>
                <div class="progress-box inactive">4</div>
            </div>
        </div>

        <div class="game-content" id="startScreen">
            <div class="start-screen">
                <div class="game-icon">üìü</div>
                <h2 style="font-size: 28px; margin-bottom: 15px; color: #1F2937;">‚è±Ô∏è Math vs Time - Go!</h2>
                <p style="color: #011b4c; margin-bottom: 10px;">Answer 4 questions correctly to win.</p>
                <p style="color: #1a1a1b; font-size: 14px; margin-bottom: 20px;">üåê Beat the clock, own the leaderboard!</p>
                
                <div class="wallet-container">
                    <div class="wallet-status">
                        <div class="wallet-indicator" id="walletIndicator"></div>
                        <span id="walletStatus">Not Connected</span>
                    </div>
                    <div id="walletInfo" style="display: none;">
                        <div id="walletAddress"></div>
                    </div>
                    <button class="btn btn-primary" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
                </div>

                <button class="btn btn-primary" id="playBtn" onclick="startGame()" disabled>Start Game</button>
            </div>
        </div>

        <div class="game-content hidden" id="gameScreen">
            <div class="game-screen">
                <div class="question-number" id="questionNumber">Question 1 of 4</div>
                <div class="question" id="question">5 + 3 = ?</div>
                <div class="feedback" id="feedback"></div>
                <div class="falling-area" id="fallingArea"></div>
            </div>
        </div>

        <div class="game-content hidden" id="resultScreen">
            <div class="result-screen">
                <div class="game-icon" id="resultIcon">üèÜ</div>
                <h2 style="font-size: 32px; margin-bottom: 15px; color: #1F2937;" id="resultTitle">You Win!</h2>
                <p style="color: #6B7280; margin-bottom: 10px;" id="resultText">Perfect Score! 4/4 correct! üéâ</p>
                <div class="result-time" id="resultTime">‚è±Ô∏è 0.00s</div>
                
                <div class="button-group">
                    <button class="btn btn-success" style="width: 100%;" onclick="submitScoreOnChain()">
                        üìä Save to Leaderboard
                    </button>
                    <button class="btn btn-warning" style="width: 100%;" onclick="claimRewardOnChain()">
                        üí∞ Claim Reward
                    </button>
                    <button class="btn btn-primary" style="width: 100%;" onclick="showLeaderboard()">
                        üèÜ View Leaderboard
                    </button>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="playAgain()">Play Again</button>
                        <button class="btn btn-share" onclick="shareGame()">üì± Share</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="leaderboard-screen hidden" id="leaderboardScreen">
            <h2 class="leaderboard-title">‚è±Ô∏è Top 50 Fastest Players</h2>
            <div class="leaderboard-list" id="leaderboardList">
                <div class="empty-leaderboard">
                    <p style="font-size: 18px; margin-bottom: 5px;">Loading leaderboard...</p>
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="hideLeaderboard()">Back to Game</button>
        </div>
    </div>

    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        sdk.actions.ready({ disableNativeGestures: true });

        let userProfile = null;
        let farcasterFID = null;

        async function fetchFarcasterProfile() {
            try {
                const context = await sdk.context;
                
                if (context?.user?.fid) {
                    farcasterFID = context.user.fid;
                    const NEYNAR_API_KEY = '8BF81B8C-C491-4735-8E1C-FC491FF048D4';
                    
                    const response = await fetch(`https://api.neynar.com/v2/farcaster/user/bulk?fids=${farcasterFID}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'api_key': NEYNAR_API_KEY
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.users && data.users.length > 0) {
                            userProfile = data.users[0];
                            updateProfileUI();
                        }
                    }
                } else {
                    userProfile = {
                        display_name: "Demo Player",
                        username: "player",
                        pfp_url: null
                    };
                    farcasterFID = 0;
                    updateProfileUI();
                }
            } catch (error) {
                console.log('Failed to fetch profile:', error);
                userProfile = {
                    display_name: "Demo Player",
                    username: "player",
                    pfp_url: null
                };
                farcasterFID = 0;
                updateProfileUI();
            }
        }

        function updateProfileUI() {
            if (!userProfile) return;

            const headerAvatar = document.getElementById('headerAvatar');

            if (userProfile.pfp_url) {
                headerAvatar.innerHTML = `<img src="${userProfile.pfp_url}" alt="Avatar">`;
            } else {
                const firstLetter = userProfile.display_name ? userProfile.display_name.charAt(0).toUpperCase() : '?';
                headerAvatar.textContent = firstLetter;
            }

            headerAvatar.classList.add('show');
        }

        window.userProfile = userProfile;
        window.getFarcasterFID = () => farcasterFID;

        (async () => {
            try {
                if (sdk?.actions?.addMiniApp) {
                    await sdk.actions.addMiniApp();
                }
                await fetchFarcasterProfile();
            } catch (err) {
                console.log('Auto addMiniApp skipped:', err.message || err);
                await fetchFarcasterProfile();
            }
        })();
    </script>

    <script type="module">
        import {
            createConfig,
            connect,
            writeContract,
            readContract,
            getAccount,
            waitForTransactionReceipt,
            watchAccount,
            http
        } from 'https://esm.sh/@wagmi/core';
        
        import { base } from 'https://esm.sh/@wagmi/core/chains';
        import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector';

const CONTRACT_ADDRESS = '0xadd4fb9ef92b6de07c970d9a1a2ee9f9f175de54';

const CONTRACT_ABI = [
    {
        "inputs": [
            {"internalType": "uint256", "name": "farcasterFID", "type": "uint256"}
        ],
        "name": "startGame",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "uint256", "name": "completionTime", "type": "uint256"},
            {"internalType": "uint256", "name": "farcasterFID", "type": "uint256"},
            {"internalType": "uint256", "name": "questionsCorrect", "type": "uint256"}
        ],
        "name": "submitScore",
        "outputs": [{"internalType": "uint256", "name": "position", "type": "uint256"}],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "uint256", "name": "farcasterFID", "type": "uint256"},
            {"internalType": "uint256", "name": "questionsCorrect", "type": "uint256"}
        ],
        "name": "claimReward",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [{"internalType": "uint256", "name": "count", "type": "uint256"}],
        "name": "getTopPlayers",
        "outputs": [{
            "components": [
                {"internalType": "address", "name": "player", "type": "address"},
                {"internalType": "uint256", "name": "farcasterFID", "type": "uint256"},
                {"internalType": "uint256", "name": "completionTime", "type": "uint256"},
                {"internalType": "uint256", "name": "timestamp", "type": "uint256"}
            ],
            "internalType": "struct MathDropGame.LeaderboardEntry[]",
            "name": "",
            "type": "tuple[]"
        }],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [{"internalType": "address", "name": "player", "type": "address"}],
        "name": "getPlayerStats",
        "outputs": [
            {"internalType": "uint256", "name": "bestTime", "type": "uint256"},
            {"internalType": "uint256", "name": "totalGames", "type": "uint256"},
            {"internalType": "uint256", "name": "totalRewardsClaimed", "type": "uint256"},
            {"internalType": "uint256", "name": "lastPlayTimestamp", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [{"internalType": "uint256", "name": "farcasterFID", "type": "uint256"}],
        "name": "getRemainingClaimsForFID",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getContractBalance",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getLeaderboardSize",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getRewardAmount",
        "outputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}],
        "stateMutability": "pure",
        "type": "function"
    }
];

        window.walletConfig = null;
        window.isWalletConnected = false;
        window.currentAccount = null;

        async function initializeWallet() {
            try {
                window.walletConfig = createConfig({
                    chains: [base],
                    connectors: [farcasterMiniApp()],
                    transports: {
                        [base.id]: http()
                    }
                });

                watchAccount(window.walletConfig, {
                    onChange: (account) => {
                        console.log('Account changed:', account);
                        updateWalletUI(account);
                    }
                });

                const account = getAccount(window.walletConfig);
                if (account.isConnected) {
                    console.log('Wallet already connected:', account.address);
                    updateWalletUI(account);
                } else {
                    try {
                        console.log('Attempting auto-connect...');
                        const result = await connect(window.walletConfig, {
                            connector: farcasterMiniApp()
                        });
                        console.log('Auto-connect successful:', result);
                        updateWalletUI(getAccount(window.walletConfig));
                    } catch (error) {
                        console.log('Auto-connect failed, manual connection required');
                        updateWalletUI(getAccount(window.walletConfig));
                    }
                }
            } catch (error) {
                console.error('Failed to initialize wallet:', error);
            }
        }

        function updateWalletUI(account) {
            if (account && account.isConnected && account.address) {
                window.isWalletConnected = true;
                window.currentAccount = account;

                document.getElementById('walletIndicator').classList.add('connected');
                document.getElementById('walletStatus').textContent = 'Connected';
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('walletAddress').textContent = 
                    `${account.address.slice(0, 6)}...${account.address.slice(-4)}`;
                
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('playBtn').disabled = false;
                
                console.log('Wallet connected:', account.address);
            } else {
                window.isWalletConnected = false;
                window.currentAccount = null;
                
                document.getElementById('walletIndicator').classList.remove('connected');
                document.getElementById('walletStatus').textContent = 'Not Connected';
                document.getElementById('walletInfo').style.display = 'none';
                document.getElementById('connectBtn').style.display = 'inline-block';
                document.getElementById('playBtn').disabled = true;
                
                console.log('Wallet disconnected');
            }
        }

        window.connectWallet = async function() {
            try {
                console.log('Manual connect triggered...');
                const result = await connect(window.walletConfig, {
                    connector: farcasterMiniApp()
                });
                console.log('Connect result:', result);
                updateWalletUI(getAccount(window.walletConfig));
            } catch (error) {
                console.error('Failed to connect wallet:', error);
                showSuccessMessage('‚ùå Failed to connect wallet: ' + error.message);
            }
        };

        window.submitScoreOnChain = async function() {
            console.log('=== SUBMIT SCORE TO BLOCKCHAIN ===');
            
            if (!window.isWalletConnected || !window.currentAccount) {
                showSuccessMessage('üîó Please connect your wallet first!');
                return;
            }

            if (window.totalCorrectAnswers !== 4) {
                showSuccessMessage('‚ùå Must complete all 4 questions correctly to submit score!');
                return;
            }

            const fid = window.getFarcasterFID();

            try {
                const playerStats = await readContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'getPlayerStats',
                    args: [window.currentAccount.address]
                });
                
                const previousBestTime = Number(playerStats[0]);
                
                if (previousBestTime > 0 && window.currentGameTime >= previousBestTime) {
                    showSuccessMessage(`‚ö†Ô∏è Not better than your best time (${window.formatTime(previousBestTime)}). Try again!`);
                    return;
                }
                
                showSuccessMessage('üìù Submitting score to blockchain...');
                
                const hash = await writeContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'submitScore',
                    args: [
                        BigInt(window.currentGameTime),
                        BigInt(fid || 0),
                        BigInt(window.totalCorrectAnswers)
                    ]
                });
                
                console.log('Transaction hash:', hash);
                showSuccessMessage('‚è≥ Confirming transaction...');
                
                const receipt = await waitForTransactionReceipt(window.walletConfig, { hash });
                console.log('Transaction receipt:', receipt);
                
                if (receipt.status === 'success') {
                    // Fetch player's rank after submitting
                    try {
                        const topPlayers = await readContract(window.walletConfig, {
                            address: CONTRACT_ADDRESS,
                            abi: CONTRACT_ABI,
                            functionName: 'getTopPlayers',
                            args: [BigInt(50)]
                        });
                        
                        const bestTimesMap = new Map();
                        topPlayers.forEach(entry => {
                            const address = entry.player.toLowerCase();
                            if (!bestTimesMap.has(address) || 
                                Number(entry.completionTime) < Number(bestTimesMap.get(address).completionTime)) {
                                bestTimesMap.set(address, entry);
                            }
                        });
                        
                        const uniquePlayers = Array.from(bestTimesMap.values())
                            .sort((a, b) => Number(a.completionTime) - Number(b.completionTime));
                        
                        const playerAddress = window.currentAccount.address.toLowerCase();
                        const rankIndex = uniquePlayers.findIndex(p => p.player.toLowerCase() === playerAddress);
                        
                        if (rankIndex !== -1) {
                            window.playerRank = rankIndex + 1;
                            console.log('Player rank:', window.playerRank);
                        }
                    } catch (error) {
                        console.log('Could not fetch rank:', error);
                    }
                    
                    if (previousBestTime === 0) {
                        showSuccessMessage('üéâ First score submitted to leaderboard!');
                    } else {
                        showSuccessMessage(`üéâ New best time! Improved from ${window.formatTime(previousBestTime)}!`);
                    }
                    
                    if (!document.getElementById('leaderboardScreen').classList.contains('hidden')) {
                        await window.loadOnChainLeaderboard();
                    }
                } else {
                    throw new Error('Transaction failed');
                }
                
            } catch (error) {
                console.error('Submit error:', error);
                let errorMessage = 'Failed to submit score. Please try again.';
                
                if (error.message.includes('User rejected')) {
                    errorMessage = '‚ùå Transaction rejected by user.';
                } else if (error.message.includes('ScoreNotBetter')) {
                    errorMessage = '‚ö†Ô∏è Score not better than your previous best!';
                } else if (error.message.includes('MustCompleteFourQuestions')) {
                    errorMessage = '‚ùå Must complete all 4 questions correctly!';
                }
                
                showSuccessMessage(errorMessage);
            }
        };

        window.claimRewardOnChain = async function() {
            console.log('=== CLAIM REWARD FROM BLOCKCHAIN ===');

            if (!window.isWalletConnected || !window.currentAccount) {
                showSuccessMessage('üîó Please connect your wallet first!');
                return;
            }

            if (window.totalCorrectAnswers !== 4) {
                showSuccessMessage('‚ùå Must complete all 4 questions correctly to claim reward!');
                return;
            }

            const fid = window.getFarcasterFID();
            
            try {
                showSuccessMessage('‚è≥ Checking eligibility...');

                const remainingClaims = await readContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'getRemainingClaimsForFID',
                    args: [BigInt(fid || 0)]
                });

                console.log('Remaining claims:', remainingClaims);

                if (remainingClaims === 0n) {
                    showSuccessMessage('‚ùå You already claimed today! Come back tomorrow.');
                    return;
                }

                const rewardAmount = await readContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'getRewardAmount'
                });
                
                console.log('Reward amount:', rewardAmount);

                const contractBalance = await readContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'getContractBalance'
                });
                
                console.log('Contract balance:', contractBalance);
                console.log('Required amount:', rewardAmount);
                
                if (contractBalance < rewardAmount) {
                    showSuccessMessage('üòî Prize pool empty! Check back later.');
                    return;
                }

                showSuccessMessage('üí∞ Claiming your reward...');
                
                const hash = await writeContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'claimReward',
                    args: [
                        BigInt(fid || 0),
                        BigInt(window.totalCorrectAnswers)
                    ]
                });
                
                console.log('Claim transaction hash:', hash);
                showSuccessMessage('üìù Transaction submitted! Confirming...');
                
                const receipt = await waitForTransactionReceipt(window.walletConfig, { hash });
                console.log('Claim receipt:', receipt);
                
                if (receipt.status === 'success') {
                    showSuccessMessage('üéâ Success! ETH sent to your wallet on Base!');
                } else {
                    throw new Error('Transaction failed');
                }
                
            } catch (error) {
                console.error('Claim error:', error);
                let errorMessage = 'Failed to claim reward.';
                
                if (error.message.includes('User rejected')) {
                    errorMessage = '‚ùå Transaction rejected.';
                } else if (error.message.includes('InsufficientBalance')) {
                    errorMessage = 'üòî Prize pool is empty! Check back later.';
                } else if (error.message.includes('ExceededDailyClaims')) {
                    errorMessage = '‚ùå Already claimed today!';
                } else if (error.message.includes('MustCompleteFourQuestions')) {
                    errorMessage = '‚ùå Must complete all 4 questions correctly!';
                }
                
                showSuccessMessage(errorMessage);
            }
        };

        window.loadOnChainLeaderboard = async function() {
            try {
                if (!window.walletConfig) {
                    console.log('Wallet not initialized yet');
                    return;
                }

                const topPlayers = await readContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'getTopPlayers',
                    args: [BigInt(50)]
                });

                console.log('Top players from chain:', topPlayers);
                displayOnChainLeaderboard(topPlayers);
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
                document.getElementById('leaderboardList').innerHTML = `
                    <div class="empty-leaderboard">
                        <p style="font-size: 18px; margin-bottom: 5px;">Failed to load leaderboard</p>
                        <p style="font-size: 14px; color: #ef4444;">${error.message}</p>
                    </div>
                `;
            }
        };

        // MAKE RANK FETCHING GLOBALLY ACCESSIBLE
        window.fetchPlayerRank = async function() {
            if (!window.isWalletConnected || !window.currentAccount || !window.walletConfig) {
                console.log('Wallet not connected, cannot fetch rank');
                return null;
            }
            
            try {
                const topPlayers = await readContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'getTopPlayers',
                    args: [BigInt(50)]
                });
                
                const bestTimesMap = new Map();
                topPlayers.forEach(entry => {
                    const address = entry.player.toLowerCase();
                    if (!bestTimesMap.has(address) || 
                        Number(entry.completionTime) < Number(bestTimesMap.get(address).completionTime)) {
                        bestTimesMap.set(address, entry);
                    }
                });
                
                const uniquePlayers = Array.from(bestTimesMap.values())
                    .sort((a, b) => Number(a.completionTime) - Number(b.completionTime));
                
                const playerAddress = window.currentAccount.address.toLowerCase();
                const rankIndex = uniquePlayers.findIndex(p => p.player.toLowerCase() === playerAddress);
                
                if (rankIndex !== -1) {
                    return rankIndex + 1;
                }
                return null;
            } catch (error) {
                console.log('Could not fetch rank:', error);
                return null;
            }
        };

        async function displayOnChainLeaderboard(players) {
            const listDiv = document.getElementById('leaderboardList');
            
            if (!players || players.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-leaderboard">
                        <p style="font-size: 18px; margin-bottom: 5px;">No scores yet!</p>
                        <p style="font-size: 14px;">Be the first to submit a score.</p>
                    </div>
                `;
                return;
            }

            const bestTimesMap = new Map();
            
            players.forEach(entry => {
                const address = entry.player.toLowerCase();
                if (!bestTimesMap.has(address) || 
                    Number(entry.completionTime) < Number(bestTimesMap.get(address).completionTime)) {
                    bestTimesMap.set(address, entry);
                }
            });
            
            const uniquePlayers = Array.from(bestTimesMap.values())
                .sort((a, b) => Number(a.completionTime) - Number(b.completionTime))
                .slice(0, 50);

            const fids = [...new Set(uniquePlayers.map(p => Number(p.farcasterFID)).filter(fid => fid > 0))];
            let profiles = {};
            
            if (fids.length > 0) {
                try {
                    const NEYNAR_API_KEY = '8BF81B8C-C491-4735-8E1C-FC491FF048D4';
                    const response = await fetch(`https://api.neynar.com/v2/farcaster/user/bulk?fids=${fids.join(',')}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'api_key': NEYNAR_API_KEY
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        data.users.forEach(user => {
                            profiles[user.fid] = user;
                        });
                    }
                } catch (error) {
                    console.log('Failed to fetch profiles:', error);
                }
            }
            
            listDiv.innerHTML = uniquePlayers.map((entry, idx) => {
                const rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : '';
                const rankIcon = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`;
                
                const fid = Number(entry.farcasterFID);
                const profile = profiles[fid];
                
                let avatarHtml;
                let displayName;
                
                if (profile && profile.pfp_url) {
                    avatarHtml = `<img src="${profile.pfp_url}" style="width: 40px; height: 40px; border-radius: 8px; margin-right: 10px;">`;
                    displayName = profile.display_name || profile.username || 'Player';
                } else {
                    const address = entry.player;
                    const letter = address.substring(2, 3).toUpperCase();
                    avatarHtml = `<div style="width: 40px; height: 40px; border-radius: 8px; background: #374151; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: white; font-weight: bold;">${letter}</div>`;
                    displayName = fid > 0 ? `FID ${fid}` : 'Anonymous';
                }
                
                return `
                    <div class="leaderboard-item ${rankClass}">
                        <div class="leaderboard-left">
                            <div class="rank-icon">${rankIcon}</div>
                            ${avatarHtml}
                            <div class="player-info">
                                <div class="player-name">${displayName}</div>
                                <div class="player-time">${window.formatTime(Number(entry.completionTime))}</div>
                                <div class="player-address">${entry.player.substring(0, 6)}...${entry.player.substring(38)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showSuccessMessage(message) {
            const existingPopup = document.querySelector('.success-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            const popup = document.createElement('div');
            popup.className = 'success-popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 4000);
        }

        window.startGame = async function() {
            if (!window.isWalletConnected) {
                alert('Please connect your wallet first!');
                return;
            }

            try {
                const playBtn = document.getElementById('playBtn');
                playBtn.disabled = true;
                playBtn.innerHTML = 'Confirming Transaction... <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px;"></div>';

                const fid = window.getFarcasterFID();

                const hash = await writeContract(window.walletConfig, {
                    address: CONTRACT_ADDRESS,
                    abi: CONTRACT_ABI,
                    functionName: 'startGame',
                    args: [BigInt(fid || 0)]
                });

                console.log('Start game transaction hash:', hash);
                
                const receipt = await waitForTransactionReceipt(window.walletConfig, { hash });
                console.log('Transaction confirmed:', receipt);

                if (receipt.status !== 'success') {
                    throw new Error('Transaction failed');
                }

                window.gameState = 'playing';
                window.currentQuestion = 0;
                window.correctAnswers = [false, false, false, false];
                window.totalCorrectAnswers = 0;
                
                document.getElementById('startScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                document.getElementById('timerDisplay').classList.remove('hidden');
                
                window.updateProgressBoxes();
                window.updateQuestionNumber();
                
                window.gameStartTime = Date.now();
                window.currentGameTime = 0;
                
                window.timerInterval = setInterval(() => {
                    window.currentGameTime = Date.now() - window.gameStartTime;
                    document.getElementById('timer').textContent = window.formatTime(window.currentGameTime);
                }, 100);
                
                window.generateQuestion();

            } catch (error) {
                console.error('Failed to start game:', error);
                
                const playBtn = document.getElementById('playBtn');
                playBtn.disabled = false;
                playBtn.textContent = 'Start Game';
                
                let errorMessage = '‚ùå Failed to start game. Please try again.';
                if (error.message.includes('User rejected')) {
                    errorMessage = '‚ùå Transaction rejected. Please try again.';
                }
                showSuccessMessage(errorMessage);
            }
        };

        initializeWallet();
    </script>

    <script>
        window.gameState = 'ready';
        window.currentQuestion = 0;
        window.correctAnswers = [false, false, false, false];
        window.correctAnswer = 0;
        window.isAnswered = false;
        window.gameStartTime = 0;
        window.currentGameTime = 0;
        window.timerInterval = null;
        window.fallTimeout = null;
        window.totalCorrectAnswers = 0;
        window.playerRank = null;

        window.generateQuestion = function() {
            const a = Math.floor(Math.random() * 10) + 1;
            const b = Math.floor(Math.random() * 10) + 1;
            const operations = ['+', '-', '√ó'];
            const op = operations[Math.floor(Math.random() * 3)];
            
            let correct;
            let questionText;
            
            if (op === '+') {
                correct = a + b;
                questionText = `${a} + ${b}`;
            } else if (op === '-') {
                const [num1, num2] = a > b ? [a, b] : [b, a];
                correct = num1 - num2;
                questionText = `${num1} - ${num2}`;
            } else {
                correct = a * b;
                questionText = `${a} √ó ${b}`;
            }
            
            window.correctAnswer = correct;
            document.getElementById('question').textContent = `${questionText} = ?`;
            
            const wrongAnswers = [
                correct + Math.floor(Math.random() * 5) + 1,
                correct - Math.floor(Math.random() * 5) - 1,
                correct + Math.floor(Math.random() * 10) + 5
            ].filter(ans => ans !== correct && ans > 0);
            
            const allAnswers = [correct, ...wrongAnswers.slice(0, 3)]
                .sort(() => Math.random() - 0.5);
            
            window.createFallingAnswers(allAnswers);
        };

        window.createFallingAnswers = function(answers) {
            const fallingArea = document.getElementById('fallingArea');
            fallingArea.innerHTML = '';
            window.isAnswered = false;
            
            answers.forEach((ans, idx) => {
                const answerDiv = document.createElement('div');
                answerDiv.className = 'falling-answer';
                answerDiv.textContent = ans;
                answerDiv.onclick = () => window.handleAnswerClick(ans);
                fallingArea.appendChild(answerDiv);
            });
            
            window.fallTimeout = setTimeout(() => {
                if (!window.isAnswered) {
                    window.handleMiss();
                }
            }, 6000);
        };

        window.handleAnswerClick = function(selected) {
            if (window.isAnswered) return;
            
            window.isAnswered = true;
            clearTimeout(window.fallTimeout);
            
            if (selected === window.correctAnswer) {
                const correctSound = document.getElementById('correctSound');
                correctSound.currentTime = 0;
                correctSound.play().catch(e => console.log('Sound play failed:', e));
                
                window.correctAnswers[window.currentQuestion] = true;
                window.totalCorrectAnswers++;
                window.updateProgressBoxes();
                window.showFeedback('üéâ Correct!', 'correct');
                
                if (window.currentQuestion === 3) {
                    clearInterval(window.timerInterval);
                    setTimeout(() => {
                        window.showWinScreen();
                    }, 800);
                } else {
                    setTimeout(() => {
                        window.currentQuestion++;
                        window.updateQuestionNumber();
                        window.generateQuestion();
                        document.getElementById('feedback').textContent = '';
                    }, 800);
                }
            } else {
                const wrongSound = document.getElementById('wrongSound');
                wrongSound.currentTime = 0;
                wrongSound.play().catch(e => console.log('Sound play failed:', e));
                
                window.showFeedback('‚ùå Wrong!', 'wrong');
                clearInterval(window.timerInterval);
                setTimeout(() => {
                    window.showGameOver();
                }, 800);
            }
        };

        window.handleMiss = function() {
            const wrongSound = document.getElementById('wrongSound');
            wrongSound.currentTime = 0;
            wrongSound.play().catch(e => console.log('Sound play failed:', e));
            
            window.showFeedback('‚è±Ô∏è Too slow!', 'wrong');
            clearInterval(window.timerInterval);
            setTimeout(() => {
                window.showGameOver();
            }, 800);
        };

        window.showFeedback = function(text, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = text;
            feedback.className = `feedback ${type}`;
        };

        window.updateProgressBoxes = function() {
            const boxes = document.querySelectorAll('.progress-box');
            boxes.forEach((box, idx) => {
                if (window.correctAnswers[idx]) {
                    box.className = 'progress-box correct';
                    box.innerHTML = '‚úì';
                } else if (idx === window.currentQuestion) {
                    box.className = 'progress-box active';
                    box.textContent = idx + 1;
                } else {
                    box.className = 'progress-box inactive';
                    box.textContent = idx + 1;
                }
            });
        };

        window.updateQuestionNumber = function() {
            document.getElementById('questionNumber').textContent = `Question ${window.currentQuestion + 1} of 4`;
        };

        window.formatTime = function(ms) {
            const seconds = Math.floor(ms / 1000);
            const milliseconds = Math.floor((ms % 1000) / 10);
            return `${seconds}.${milliseconds.toString().padStart(2, '0')}s`;
        };

        window.showWinScreen = async function() {
            const winSound = document.getElementById('winSound');
            winSound.currentTime = 0;
            winSound.play().catch(e => console.log('Sound play failed:', e));
            
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            document.getElementById('timerDisplay').classList.add('hidden');
            
            document.getElementById('resultIcon').textContent = 'üèÜ';
            document.getElementById('resultTitle').textContent = 'You Win!';
            document.getElementById('resultText').textContent = 'Perfect Score! 4/4 correct! üéâ';
            document.getElementById('resultTime').textContent = `‚è±Ô∏è ${window.formatTime(window.currentGameTime)}`;
            
            const submitBtn = document.querySelector('[onclick="submitScoreOnChain()"]');
            const claimBtn = document.querySelector('[onclick="claimRewardOnChain()"]');
            const shareBtn = document.querySelector('[onclick="shareGame()"]');
            if (submitBtn) submitBtn.style.display = 'block';
            if (claimBtn) claimBtn.style.display = 'block';
            if (shareBtn) shareBtn.style.display = 'inline-block';
            
            // AUTO-FETCH PLAYER'S RANK
            if (window.fetchPlayerRank) {
                window.playerRank = await window.fetchPlayerRank();
                console.log('Player rank fetched on win screen:', window.playerRank);
            }
        };

        window.showGameOver = function() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            document.getElementById('timerDisplay').classList.add('hidden');
            
            document.getElementById('resultIcon').textContent = 'üí•';
            document.getElementById('resultTitle').textContent = 'Game Over!';
            document.getElementById('resultText').textContent = `You got ${window.correctAnswers.filter(Boolean).length} out of 4 correct`;
            document.getElementById('resultTime').classList.add('hidden');
            
            const submitBtn = document.querySelector('[onclick="submitScoreOnChain()"]');
            const claimBtn = document.querySelector('[onclick="claimRewardOnChain()"]');
            const shareBtn = document.querySelector('[onclick="shareGame()"]');
            if (submitBtn) submitBtn.style.display = 'none';
            if (claimBtn) claimBtn.style.display = 'none';
            if (shareBtn) shareBtn.style.display = 'none';
        };

        window.playAgain = function() {
            window.gameState = 'ready';
            window.playerRank = null;
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('resultTime').classList.remove('hidden');
            
            const playBtn = document.getElementById('playBtn');
            playBtn.disabled = false;
            playBtn.textContent = 'Start Game';
            playBtn.innerHTML = 'Start Game';
            
            const boxes = document.querySelectorAll('.progress-box');
            boxes.forEach((box, idx) => {
                box.className = 'progress-box inactive';
                box.textContent = idx + 1;
            });
        };

        window.showLeaderboard = function() {
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            window.loadOnChainLeaderboard();
        };

        window.toggleLeaderboard = function() {
            const leaderboardScreen = document.getElementById('leaderboardScreen');
            const startScreen = document.getElementById('startScreen');
            const gameScreen = document.getElementById('gameScreen');
            const resultScreen = document.getElementById('resultScreen');
            
            if (leaderboardScreen.classList.contains('hidden')) {
                leaderboardScreen.classList.remove('hidden');
                startScreen.classList.add('hidden');
                gameScreen.classList.add('hidden');
                resultScreen.classList.add('hidden');
                window.loadOnChainLeaderboard();
            } else {
                window.hideLeaderboard();
            }
        };

        window.hideLeaderboard = function() {
            document.getElementById('leaderboardScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            window.gameState = 'ready';
            
            const playBtn = document.getElementById('playBtn');
            playBtn.disabled = false;
            playBtn.textContent = 'Start Game';
            playBtn.innerHTML = 'Start Game';
        };

window.shareGame = function() {
    let shareText = `üî• Just completed Quick Math in ${window.formatTime(window.currentGameTime)}!\n\n`;
    
    // Add rank if available
    if (window.playerRank !== null) {
        if (window.playerRank === 1) {
            shareText += 'ü•á Rank #1\n';
        } else if (window.playerRank === 2) {
            shareText += 'ü•à Rank #2\n';
        } else if (window.playerRank === 3) {
            shareText += 'ü•â Rank #3\n';
        } else {
            shareText += `üèÜ Rank #${window.playerRank}\n`;
        }
    }
    
    shareText += 'üìã 4/4 correct - Score submitted onchain.\n';
    shareText += '‚û§ Claimed my reward.\n';
    shareText += 'ü•∑üèª Beat my time if you can!';
    
    const encodedText = encodeURIComponent(shareText);
    const shareUrl = encodeURIComponent(window.location.href);
    const castUrl = `https://farcaster.xyz/~/compose?text=${encodedText}&embeds[]=${shareUrl}`;
    window.open(castUrl, '_blank');
};
    </script>
</body>
</html>